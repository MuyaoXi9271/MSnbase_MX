<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Combine signal from consecutive spectra of LCMS experiments — combineSpectraMovingWindow • MSnbase</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Combine signal from consecutive spectra of LCMS experiments — combineSpectraMovingWindow" />
<meta property="og:description" content="combineSpectraMovingWindow combines signal from consecutive spectra within
a file. The resulting MSnExp has the same total number of spectra than the
original object, but with each individual's spectrum information
representing aggregated data from the original spectrum and its neighboring
spectra. This is thus equivalent with a smoothing of the data in retention
time dimension.
Note that the function returns always a MSnExp object, even if x was an
OnDiskMSnExp object." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MSnbase</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.17.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/v01-MSnbase-demo.html">MSnbase: MS data processing, visualisation and quantification</a>
    </li>
    <li>
      <a href="../articles/v02-MSnbase-io.html">MSnbase IO capabilities</a>
    </li>
    <li>
      <a href="../articles/v03-MSnbase-centroiding.html">MSnbase: centroiding of profile-mode MS data</a>
    </li>
    <li>
      <a href="../articles/v04-benchmarking.html">MSnbase benchmarking</a>
    </li>
    <li>
      <a href="../articles/v05-MSnbase-development.html">A short introduction to *MSnbase* development</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/lgatto/MSnbase/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Combine signal from consecutive spectra of LCMS experiments</h1>
    <small class="dont-index">Source: <a href='https://github.com/lgatto/MSnbase/blob/master/R/functions-MSnExp.R'><code>R/functions-MSnExp.R</code></a></small>
    <div class="hidden name"><code>combineSpectraMovingWindow.Rd</code></div>
    </div>

    <div class="ref-description">
    <p><code>combineSpectraMovingWindow</code> combines signal from consecutive spectra within
a file. The resulting <code>MSnExp</code> has the same total number of spectra than the
original object, but with each individual's spectrum information
representing aggregated data from the original spectrum and its neighboring
spectra. This is thus equivalent with a smoothing of the data in retention
time dimension.</p>
<p>Note that the function returns always a <code>MSnExp</code> object, even if <code>x</code> was an
<code>OnDiskMSnExp</code> object.</p>
    </div>

    <pre class="usage"><span class='fu'>combineSpectraMovingWindow</span><span class='op'>(</span>
  <span class='va'>x</span>,
  halfWindowSize <span class='op'>=</span> <span class='fl'>1L</span>,
  intensityFun <span class='op'>=</span> <span class='fu'>base</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span>,
  mzd <span class='op'>=</span> <span class='cn'>NULL</span>,
  timeDomain <span class='op'>=</span> <span class='cn'>FALSE</span>,
  weighted <span class='op'>=</span> <span class='cn'>FALSE</span>,
  ppm <span class='op'>=</span> <span class='fl'>0</span>,
  BPPARAM <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/BiocParallel/man/register.html'>bpparam</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>x</th>
      <td><p><code>MSnExp</code> or <code>OnDiskMSnExp</code> object.</p></td>
    </tr>
    <tr>
      <th>halfWindowSize</th>
      <td><p><code><a href='https://rdrr.io/r/base/integer.html'>integer(1)</a></code> with the half window size for the moving
window.</p></td>
    </tr>
    <tr>
      <th>intensityFun</th>
      <td><p><code>function</code> to aggregate the intensity values per m/z
group. Should be a function or the name of a function. The function is
expected to return a <code><a href='https://rdrr.io/r/base/numeric.html'>numeric(1)</a></code>.</p></td>
    </tr>
    <tr>
      <th>mzd</th>
      <td><p><code><a href='https://rdrr.io/r/base/numeric.html'>numeric(1)</a></code> defining the maximal m/z difference below which
mass peaks are considered to represent the same ion/mass peak.
Intensity values for such grouped mass peaks are aggregated. If not
specified this value is estimated from the distribution of differences
of m/z values from the provided spectra (see details).</p></td>
    </tr>
    <tr>
      <th>timeDomain</th>
      <td><p><code><a href='https://rdrr.io/r/base/logical.html'>logical(1)</a></code> whether definition of the m/z values to be
combined into one m/z is performed on m/z values
(<code>timeDomain = FALSE</code>) or on <code><a href='https://rdrr.io/r/base/MathFun.html'>sqrt(mz)</a></code> (<code>timeDomain = TRUE</code>).
Profile data from TOF MS instruments should be aggregated based
on the time domain (see details). Note that a pre-defined <code>mzd</code> should
also be estimated on the square root of m/z values if
<code>timeDomain = TRUE</code>.</p></td>
    </tr>
    <tr>
      <th>weighted</th>
      <td><p><code><a href='https://rdrr.io/r/base/logical.html'>logical(1)</a></code> whether m/z values per m/z group should be
aggregated with an intensity-weighted mean. The default is to report
the mean m/z.</p></td>
    </tr>
    <tr>
      <th>ppm</th>
      <td><p><code><a href='https://rdrr.io/r/base/numeric.html'>numeric(1)</a></code> to define an m/z relative deviation. Note that if
only <code>ppm</code> should be considered but not <code>mzd</code>, <code>mzd</code> should be set to
<code>0</code> (i.e. <code>mzd = 0</code>). This parameter is directly passed to
<code><a href='meanMzInts.html'>meanMzInts()</a></code>.</p></td>
    </tr>
    <tr>
      <th>BPPARAM</th>
      <td><p>parallel processing settings.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p><code>MSnExp</code> with the same number of spectra than <code>x</code>.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The method assumes same ions being measured in consecutive scans (i.e. LCMS
data) and thus combines their signal which can increase the increase the
signal to noise ratio.</p>
<p>Intensities (and m/z values) for signals with the same m/z value in
consecutive scans are aggregated using the <code>intensityFun</code>.
m/z values of intensities from consecutive scans will never be exactly
identical, even if they represent signal from the same ion. The function
determines thus internally a similarity threshold based on differences
between m/z values within and between spectra below which m/z values are
considered to derive from the same ion. For robustness reasons, this
threshold is estimated on the 100 spectra with the largest number of
m/z - intensity pairs (i.e. mass peaks).</p>
<p>See <code><a href='meanMzInts.html'>meanMzInts()</a></code> for details.</p>
<p>Parameter <code>timeDomain</code>: by default, m/z-intensity pairs from consecutive
scans to be aggregated are defined based on the square root of the m/z
values. This is because it is highly likely that in all QTOF MS instruments
data is collected based on a timing circuit (with a certain variance) and
m/z values are later derived based on the relationship <code>t = k * sqrt(m/z)</code>.
Differences between individual m/z values will thus be dependent on the
actual m/z value causing both the difference between m/z values and their
scattering being different in the lower and upper m/z range. Determining
m/z values to be combined on the <code><a href='https://rdrr.io/r/base/MathFun.html'>sqrt(mz)</a></code> reduces this dependency. For
non-QTOF MS data <code>timeDomain = FALSE</code> might be used instead.</p>
    <h2 class="hasAnchor" id="note"><a class="anchor" href="#note"></a>Note</h2>

    <p>The function has to read all data into memory for the spectra combining
and thus the memory requirements of this function are high, possibly
preventing its usage on large experimental data. In these cases it is
suggested to perform the combination on a per-file basis and save the
results using the <code><a href='writeMSData,MSnExp,character-method.html'>writeMSData()</a></code> function afterwards.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='meanMzInts.html'>meanMzInts()</a></code> for the function combining spectra provided in
a <code>list</code>.</p>
<p><code><a href='estimateMzScattering.html'>estimateMzScattering()</a></code> for a function to estimate m/z value scattering in
consecutive spectra.</p></div>
    <h2 class="hasAnchor" id="author"><a class="anchor" href="#author"></a>Author</h2>

    <p>Johannes Rainer, Sigurdur Smarason</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://lgatto.github.io/MSnbase'>MSnbase</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>msdata</span><span class='op'>)</span>

<span class='co'>## Read a profile-mode LC-MS data file.</span>
<span class='va'>fl</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.files.html'>dir</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/system.file.html'>system.file</a></span><span class='op'>(</span><span class='st'>"sciex"</span>, package <span class='op'>=</span> <span class='st'>"msdata"</span><span class='op'>)</span>, full.names <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span>
<span class='va'>od</span> <span class='op'>&lt;-</span> <span class='fu'><a href='readMSData.html'>readMSData</a></span><span class='op'>(</span><span class='va'>fl</span>, mode <span class='op'>=</span> <span class='st'>"onDisk"</span><span class='op'>)</span>

<span class='co'>## Subset the object to the retention time range that includes the signal</span>
<span class='co'>## for proline. This is done for performance reasons.</span>
<span class='va'>rtr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>165</span>, <span class='fl'>175</span><span class='op'>)</span>
<span class='va'>od</span> <span class='op'>&lt;-</span> <span class='fu'><a href='MSnExp-class.html'>filterRt</a></span><span class='op'>(</span><span class='va'>od</span>, <span class='va'>rtr</span><span class='op'>)</span>

<span class='co'>## Combine signal from neighboring spectra.</span>
<span class='va'>od_comb</span> <span class='op'>&lt;-</span> <span class='fu'>combineSpectraMovingWindow</span><span class='op'>(</span><span class='va'>od</span><span class='op'>)</span>

<span class='co'>## The combined spectra have the same number of spectra, same number of</span>
<span class='co'>## mass peaks per spectra, but the signal is larger in the combined object.</span>
<span class='fu'><a href='pSet-class.html'>length</a></span><span class='op'>(</span><span class='va'>od</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 36</div><div class='input'><span class='fu'><a href='pSet-class.html'>length</a></span><span class='op'>(</span><span class='va'>od_comb</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 36</div><div class='input'>
<span class='fu'><a href='Spectrum-class.html'>peaksCount</a></span><span class='op'>(</span><span class='va'>od</span><span class='op'>)</span>
</div><div class='output co'>#&gt; F1.S592 F1.S593 F1.S594 F1.S595 F1.S596 F1.S597 F1.S598 F1.S599 F1.S600 F1.S601 
#&gt;     681     745     763     848     713     963    1126    1016     756     796 
#&gt; F1.S602 F1.S603 F1.S604 F1.S605 F1.S606 F1.S607 F1.S608 F1.S609 F1.S610 F1.S611 
#&gt;     861     830     710     815     739     693     659     734    1054    1246 
#&gt; F1.S612 F1.S613 F1.S614 F1.S615 F1.S616 F1.S617 F1.S618 F1.S619 F1.S620 F1.S621 
#&gt;    1509    1590    1943    2130    2166    2923    2816    2123    1744    1704 
#&gt; F1.S622 F1.S623 F1.S624 F1.S625 F1.S626 F1.S627 
#&gt;    2073    2015    1910    1859    1853    1762 </div><div class='input'><span class='fu'><a href='Spectrum-class.html'>peaksCount</a></span><span class='op'>(</span><span class='va'>od_comb</span><span class='op'>)</span>
</div><div class='output co'>#&gt; F1.S592 F1.S593 F1.S594 F1.S595 F1.S596 F1.S597 F1.S598 F1.S599 F1.S600 F1.S601 
#&gt;     681     745     763     848     713     963    1126    1016     756     796 
#&gt; F1.S602 F1.S603 F1.S604 F1.S605 F1.S606 F1.S607 F1.S608 F1.S609 F1.S610 F1.S611 
#&gt;     861     830     710     815     739     693     659     734    1054    1246 
#&gt; F1.S612 F1.S613 F1.S614 F1.S615 F1.S616 F1.S617 F1.S618 F1.S619 F1.S620 F1.S621 
#&gt;    1509    1590    1943    2130    2166    2923    2816    2123    1744    1704 
#&gt; F1.S622 F1.S623 F1.S624 F1.S625 F1.S626 F1.S627 
#&gt;    2073    2015    1910    1859    1853    1762 </div><div class='input'>
<span class='co'>## Comparing the chromatographic signal for proline (m/z ~ 116.0706)</span>
<span class='co'>## before and after spectra data combination.</span>
<span class='va'>mzr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>116.065</span>, <span class='fl'>116.075</span><span class='op'>)</span>
<span class='va'>chr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='chromatogram,MSnExp-method.html'>chromatogram</a></span><span class='op'>(</span><span class='va'>od</span>, rt <span class='op'>=</span> <span class='va'>rtr</span>, mz <span class='op'>=</span> <span class='va'>mzr</span><span class='op'>)</span>
<span class='va'>chr_comb</span> <span class='op'>&lt;-</span> <span class='fu'><a href='chromatogram,MSnExp-method.html'>chromatogram</a></span><span class='op'>(</span><span class='va'>od_comb</span>, rt <span class='op'>=</span> <span class='va'>rtr</span>, mz <span class='op'>=</span> <span class='va'>mzr</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/graphics/par.html'>par</a></span><span class='op'>(</span>mfrow <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='plot-methods.html'>plot</a></span><span class='op'>(</span><span class='va'>chr</span><span class='op'>)</span>
<span class='fu'><a href='plot-methods.html'>plot</a></span><span class='op'>(</span><span class='va'>chr_comb</span><span class='op'>)</span>
</div><div class='img'><img src='combineSpectraMovingWindow-1.png' alt='' width='700' height='433' /></div><div class='input'><span class='co'>## Chromatographic data is "smoother" after combining.</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Laurent Gatto, Johannes Rainer, Sebastian Gibb.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


